#!/usr/bin/env bash
##
# Script runner.
#
# @since 1.0.0
#
# @note PLEASE DO NOT EDIT THIS FILE!
# This file and the contents of it are updated automatically.
# - Instead of editing this file, please review source repository {@see https://o5p.me/LevQOD}.
##
# ---------------------------------------------------------------------------------------------------------------------
# $ ./.run-script [script] [args];
# ---------------------------------------------------------------------------------------------------------------------

# Suggested alias for a `~/.profile` customization:
#  function run() { ./.run-script "${@}"; };

# ---------------------------------------------------------------------------------------------------------------------
# Setup & validation.
# ---------------------------------------------------------------------------------------------------------------------

if ! cd "$(dirname "${BASH_SOURCE[0]}")"; then
	echo -e "\e[38;5;255m\e[48;5;124m\e[1mFailed to CD into: ${BASH_SOURCE[0]}\e[0m\e[49m\e[39m";
	exit 1; # Exit w/ error status.
fi;
if [[ -f ./.c10n-utilities ]]; then c10n_utilities_dir=.;
else c10n_utilities_dir=./vendor/clevercanyon/utilities; fi;

if [[ ! -f "${c10n_utilities_dir}"/dev/utilities/load.bash ]]; then
	echo -e "\e[38;5;255m\e[48;5;124m\e[1mMissing required dependency: '${c10n_utilities_dir}/dev/utilities/load.bash'\e[0m\e[49m\e[39m";
	echo -e "\e[38;5;255m\e[48;5;124m\e[1mHave you run 'composer install' yet?\e[0m\e[49m\e[39m";
	exit 1; # Exit w/ error status.
fi;
if [[ ! -d ./vendor/bin || ! -d ./node_modules/.bin ]]; then
	echo -e "\e[38;5;255m\e[48;5;124m\e[1mMissing required dependency: './vendor/bin | ./node_modules/.bin'\e[0m\e[49m\e[39m";
	echo -e "\e[38;5;255m\e[48;5;124m\e[1mHave you run 'composer install' yet?\e[0m\e[49m\e[39m";
	exit 1; # Exit w/ error status.
fi;
. "${c10n_utilities_dir}"/dev/utilities/load.bash; # Loads utilities.
. "${c10n_utilities_dir}"/dev/utilities/bash/partials/loose-mode;

# ---------------------------------------------------------------------------------------------------------------------
# Runs a command based on script name; i.e., arg "${1}".
# ---------------------------------------------------------------------------------------------------------------------

case "${1:-}" in
	'phpunit')
		if is-wp-docker; then
			phpunit \
				--configuration ./dev/.libs/phpunit/config~wp-docker.xml \
				--no-coverage --no-logging --do-not-cache-result "${@:2}";

		elif can-run phpunit; then
			phpunit \
				--configuration ./dev/.libs/phpunit/config.xml \
				--no-coverage --no-logging "${@:2}";
		else
			composer exec --profile -- phpunit \
				--configuration ./dev/.libs/phpunit/config.xml \
				--no-coverage --no-logging "${@:2}";
		fi;;

	'phpunit~distro')
		if is-wp-docker; then
			phpunit \
				--configuration ./dev/.libs/phpunit/config~wp-docker~distro.xml \
				--no-coverage --no-logging --do-not-cache-result "${@:2}";

		elif can-run phpunit; then
			phpunit \
				--configuration ./dev/.libs/phpunit/config~distro.xml \
				--no-coverage --no-logging "${@:2}";
		else
			composer exec --profile -- phpunit \
				--configuration ./dev/.libs/phpunit/config~distro.xml \
				--no-coverage --no-logging "${@:2}";
		fi;;

	'phpunit~coverage')
		if is-wp-docker; then
			echo 'Not supported in a WP Docker environment. Please run locally.';
			exit 1; # Exit w/ error status.

		elif can-run phpunit; then
			XDEBUG_MODE=coverage phpunit \
				--configuration ./dev/.libs/phpunit/config.xml \
				--no-logging "${@:2}";
		else
			XDEBUG_MODE=coverage composer exec --profile -- phpunit \
				--configuration ./dev/.libs/phpunit/config.xml \
				--no-logging "${@:2}";
		fi;;

	'php-scoper-config-file-update')
		if is-wp-docker; then
			echo 'Not supported in a WP Docker environment. Please run locally.';
			exit 1; # Exit w/ error status.

		elif ! is-c10n-utilities; then
			echo 'Unexpected context. Please run from `clevercanyon/utilities`.';
			exit 1; # Exit w/ error status.
		else
			./dev/cli-tools/php-scoper/config-file update;
		fi;;

	'skeleton')
		"${c10n_utilities_dir}"/dev/cli-tools/composer/skeleton "${@:2}";
		;;

	'compile') # {@see https://o5p.me/nCP9tQ}.
		if confirm 'Compile. Are you sure?'; then
		    composer compile "${@:2}";
		else
			exit 0; # Low confidence.
		fi;
		;;

	'webpack')
		npx webpack --config ./dev/.libs/webpack/config.cjs "${@:2}";
		;;

	'wp-docker')
		./.wp-docker "${@:2}";
		;;

	'composer')
		composer "${@:2}";
		;;

	'npm')
		npm "${@:2}";
		;;

	*)
		echo 'Hmm. `'"${1:-}"'` is an unexpected script name.';

		echo 'Did you mean one of these?';
		echo;
		echo '- phpunit';
		echo '- phpunit~distro';
		echo '- phpunit~coverage';
		if is-c10n-utilities; then
			echo '- php-scoper-config-file-update';
		fi;
		echo '- webpack';
		echo '- wp-docker';
		echo '- composer';
		echo '- npm';
		echo;
		echo 'e.g., ./.run-script phpunit;';

		exit 1; # Exit w/ error status.
esac;

# ---------------------------------------------------------------------------------------------------------------------
# Dev notes.
# ---------------------------------------------------------------------------------------------------------------------

# This file will preference a global copy of PHPUnit to avoid loading issues.
# In general, it is better to run a global installation of PHPUnit for testing.

# More specifically; note the use of a global `phpunit` when running on WP Docker.
# We must avoid loading Composer dependencies out of order in a WP Docker container.
# WordPress needs to be loaded, along with, potentially, the project itself; in a very specific order.

# This is why `./vendor/bin/phpunit` & `composer exec -- phpunit` are bypassed in a WP Docker container.
# It should be left entirely up to `tests/bootstrap.php` and not for Composer to load anything automatically.

# To clarify further. Composerâ€™s `exec` and `run-script` commands will automatically pull in `vendor/autoload.php`.
# Just about anything in `vendor/bin` will do the exact same thing, since they are all reliant upon Composer.

# Caching is disabled on WP Docker. The project directory is not writable.
